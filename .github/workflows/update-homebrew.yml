name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: NOMARJ/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Get release info
        id: release
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

      - name: Download checksums
        run: |
          curl -sSL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/SHA256SUMS.txt" -o SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Extract SHA256 hashes
        id: hashes
        run: |
          MACOS_ARM64_SHA=$(grep "sigil-macos-arm64.tar.gz" SHA256SUMS.txt | awk '{print $1}')
          MACOS_X64_SHA=$(grep "sigil-macos-x64.tar.gz" SHA256SUMS.txt | awk '{print $1}')
          LINUX_X64_SHA=$(grep "sigil-linux-x64.tar.gz" SHA256SUMS.txt | awk '{print $1}')

          echo "macos_arm64_sha=$MACOS_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "macos_x64_sha=$MACOS_X64_SHA" >> $GITHUB_OUTPUT
          echo "linux_x64_sha=$LINUX_X64_SHA" >> $GITHUB_OUTPUT

      - name: Update Formula
        run: |
          cat > homebrew-tap/Formula/sigil.rb << 'EOF'
          class Sigil < Formula
            desc "Automated security auditing for AI agent code"
            homepage "https://sigilsec.ai"
            license "Apache-2.0"
            version "${{ steps.release.outputs.version }}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/sigil-macos-arm64.tar.gz"
                sha256 "${{ steps.hashes.outputs.macos_arm64_sha }}"
              else
                url "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/sigil-macos-x64.tar.gz"
                sha256 "${{ steps.hashes.outputs.macos_x64_sha }}"
              end
            end

            on_linux do
              url "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/sigil-linux-x64.tar.gz"
              sha256 "${{ steps.hashes.outputs.linux_x64_sha }}"
            end

            def install
              bin.install "sigil"
            end

            def post_install
              system "#{bin}/sigil", "install" rescue nil
            end

            test do
              assert_match "SIGIL", shell_output("#{bin}/sigil --version")
              (testpath/"test.py").write("print('hello')")
              system "#{bin}/sigil", "scan", testpath/"test.py"
            end
          end
          EOF

      - name: Commit and push
        working-directory: homebrew-tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/sigil.rb
          git commit -m "Update sigil to ${{ steps.release.outputs.version }}"
          git push
