name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Bash CLI ────────────────────────────────────────────────────────────────
  lint-bash:
    name: Lint Bash (ShellCheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: bin/
          severity: warning

  test-scan:
    name: Self-Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run sigil self-scan
        run: |
          chmod +x bin/sigil
          ./bin/sigil scan .

  # ── Python API ──────────────────────────────────────────────────────────────
  lint-python:
    name: Lint Python (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: pip install ruff flake8

      - name: Run ruff check
        run: ruff check api/

      - name: Run ruff format check
        run: ruff format --check api/

  test-api:
    name: Test API (pytest)
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r api/requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run tests
        run: pytest api/ -v --tb=short
        env:
          SIGIL_JWT_SECRET: test-secret-for-ci
          SIGIL_DEBUG: "true"

  # ── Rust CLI ────────────────────────────────────────────────────────────────
  lint-rust:
    name: Lint Rust (clippy)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            cli/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('cli/Cargo.toml') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Run clippy
        working-directory: cli
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check formatting
        working-directory: cli
        run: cargo fmt -- --check

  build-rust:
    name: Build Rust
    runs-on: ubuntu-latest
    needs: lint-rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            cli/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('cli/Cargo.toml') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build
        working-directory: cli
        run: cargo build --release

      - name: Run tests
        working-directory: cli
        run: cargo test --release

  # ── VS Code Extension ──────────────────────────────────────────────────────
  lint-vscode:
    name: Lint VS Code Extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: plugins/vscode
        run: npm install

      - name: TypeScript compile
        working-directory: plugins/vscode
        run: npx tsc --noEmit

  # ── MCP Server ────────────────────────────────────────────────────────────
  lint-mcp:
    name: Lint MCP Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: plugins/mcp-server
        run: npm install

      - name: TypeScript compile
        working-directory: plugins/mcp-server
        run: npx tsc --noEmit

  # ── JetBrains Plugin ─────────────────────────────────────────────────────
  lint-jetbrains:
    name: Build JetBrains Plugin
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build plugin
        working-directory: plugins/jetbrains
        run: gradle buildPlugin

  # ── Dashboard ───────────────────────────────────────────────────────────────
  lint-dashboard:
    name: Lint Dashboard (TypeScript)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: dashboard/package-lock.json

      - name: Install dependencies
        working-directory: dashboard
        run: npm ci || npm install

      - name: TypeScript type check
        working-directory: dashboard
        run: npx tsc --noEmit

      - name: Lint
        working-directory: dashboard
        run: npm run lint

      - name: Build
        working-directory: dashboard
        run: npm run build
