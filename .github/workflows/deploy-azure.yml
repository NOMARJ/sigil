name: Deploy to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - 'bot/**'
      - 'dashboard/**'
      - 'Dockerfile.bot'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  ACR_NAME: sigilacr46iy6y
  ACR_LOGIN_SERVER: sigilacr46iy6y.azurecr.io

jobs:
  build-and-push:
    name: Build and Push Images to ACR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    outputs:
      api-image-tag: ${{ steps.meta.outputs.api-tag }}
      bot-image-tag: ${{ steps.meta.outputs.bot-tag }}
      dashboard-image-tag: ${{ steps.meta.outputs.dashboard-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3

      - name: Log in to Azure
        uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tags
        id: meta
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "api-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "bot-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "dashboard-tag=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "API Image: ${{ env.ACR_LOGIN_SERVER }}/sigil-api:${SHORT_SHA}"
          echo "Bot Image: ${{ env.ACR_LOGIN_SERVER }}/sigil-bot:${SHORT_SHA}"
          echo "Dashboard Image: ${{ env.ACR_LOGIN_SERVER }}/sigil-dashboard:${SHORT_SHA}"

      - name: Build and push API image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v5
        with:
          context: .
          file: ./api/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sigil-api:latest
            ${{ env.ACR_LOGIN_SERVER }}/sigil-api:${{ steps.meta.outputs.api-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Bot image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v5
        with:
          context: .
          file: ./Dockerfile.bot
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sigil-bot:latest
            ${{ env.ACR_LOGIN_SERVER }}/sigil-bot:${{ steps.meta.outputs.bot-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Dashboard image
        uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v5
        with:
          context: ./dashboard
          file: ./dashboard/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/sigil-dashboard:latest
            ${{ env.ACR_LOGIN_SERVER }}/sigil-dashboard:${{ steps.meta.outputs.dashboard-tag }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.sigilsec.ai
            NEXT_PUBLIC_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trigger-infrastructure-deployment:
    name: Trigger Infrastructure Deployment
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Trigger sigil-infra deployment
        uses: peter-evans/repository-dispatch@ff45666b9427631e3450c54a1bcbee4d9ff4d7c0 # v3
        with:
          token: ${{ secrets.INFRA_REPO_PAT }}
          repository: NOMARJ/sigil-infra
          event-type: deploy-infrastructure
          client-payload: |
            {
              "source_repo": "${{ github.repository }}",
              "source_ref": "${{ github.ref }}",
              "source_sha": "${{ github.sha }}",
              "api_image_tag": "${{ needs.build-and-push.outputs.api-image-tag }}",
              "bot_image_tag": "${{ needs.build-and-push.outputs.bot-image-tag }}",
              "dashboard_image_tag": "${{ needs.build-and-push.outputs.dashboard-image-tag }}",
              "triggered_by": "${{ github.actor }}",
              "environment": "${{ inputs.environment || 'production' }}"
            }

      - name: Deployment triggered
        run: |
          echo "Infrastructure deployment triggered in NOMARJ/sigil-infra"
          echo "Image tags:"
          echo "  - API: ${{ needs.build-and-push.outputs.api-image-tag }}"
          echo "  - Bot: ${{ needs.build-and-push.outputs.bot-image-tag }}"
          echo "  - Dashboard: ${{ needs.build-and-push.outputs.dashboard-image-tag }}"
